name: CI/CD üöÄ

permissions:
  id-token: write
  contents: read

on:
  push:
  pull_request:
    types: [ opened, reopened, edited, synchronize ]

jobs:
  gitflow_enforcer:
    name: Gitflow Enforcer üëÆüèª
    runs-on: ubuntu-latest
    steps:
      - name: Check branch
        if: github.base_ref == 'main' && github.head_ref != 'dev' || github.base_ref == 'production' && github.head_ref != 'main'
        run: |
          echo "ERROR: You can only merge to main from dev and to production from main"
          exit 1
  define-environment:
    name: Set ‚ú® environment ‚ú® based on the branch üå≥
    needs: gitflow_enforcer
    runs-on: ubuntu-latest
    steps:
      - name: Set the environment
        id: define_environment
        run: |
          if [ "${{ github.base_ref }}" = "main" ]; then
            echo "env_name=staging" >> $GITHUB_OUTPUT
          elif [ "${{ github.base_ref }}" = "dev" ]; then
            echo "env_name=development" >> $GITHUB_OUTPUT
          elif [ "${{ github.base_ref }}" = "production" ]; then
            echo "env_name=production" >> $GITHUB_OUTPUT
          else
            echo "No environment associated with ${{ github.base_ref }} branch"
            exit 1
          fi
      - name: Print the environment
        run: echo "The environment is ${{ steps.define_environment.outputs.env_name }}"

    outputs:
      env_name: ${{ steps.define_environment.outputs.env_name }}

  deploy-veda-auth:
    name: Deploy VEDA auth üîê
    runs-on: ubuntu-latest
    env:
      DIRECTORY: veda-auth-stack
    needs: define-environment
    if: ${{ needs.define-environment.outputs.env_name }}
    environment: ${{ needs.define-environment.outputs.env_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          lfs: "true"
          submodules: "recursive"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.DEPLOYMENT_ROLE_ARN }}
          role-session-name: "${{ env.DIRECTORY }}-github-${{ needs.define-environment.outputs.env_name }}-deployment"
          aws-region: "us-west-2"
      - name: Run auth deployment
        uses: "./veda-auth-stack/.github/actions/cdk-deploy"
        with:
          dir: "${{ env.DIRECTORY }}"
          env_aws_secret_name: ${{ vars.DEPLOYMENT_ENV_SECRET_NAME }}
          script_path: "${{ github.workspace }}/scripts/generate_env_file.py"

  deploy-veda-backend:
    name: Deploy VEDA backend ‚öôÔ∏è
    runs-on: ubuntu-latest
    env:
      DIRECTORY: veda-backend-stack
    needs: define-environment
    environment: ${{ needs.define-environment.outputs.env_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          lfs: "true"
          submodules: "recursive"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.DEPLOYMENT_ROLE_ARN }}
          role-session-name: "${{ env.DIRECTORY }}-github-${{ needs.define-environment.outputs.env_name }}-deployment"
          aws-region: "us-west-2"

      - name: Run deployment
        uses: "./veda-backend-stack/.github/actions/cdk-deploy"
        with:
          env_aws_secret_name: ${{ vars.DEPLOYMENT_ENV_SECRET_NAME }}
          dir: "${{ env.DIRECTORY }}"


  deploy-veda-stac-ingestor:
    name: deploy VEDA stac ingestor üçΩÔ∏è (without airflow integration)
    runs-on: ubuntu-latest
    env:
      DIRECTORY: veda-ingest-stack
      AWS_REGION: "us-west-2"
    needs: [deploy-veda-backend, deploy-veda-auth, define-environment]
    environment: ${{ needs.define-environment.outputs.env_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          lfs: "true"
          submodules: "recursive"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.DEPLOYMENT_ROLE_ARN }}
          role-session-name: "${{ env.DIRECTORY }}-github-${{ needs.define-environment.outputs.env_name }}-deployment"
          aws-region: "${{ env.AWS_REGION }}"

      - name: Run deployment
        uses: "./veda-ingest-stack/.github/actions/cdk-deploy"
        with:
          env_aws_secret_name: ${{ vars.DEPLOYMENT_ENV_SECRET_NAME }}
          dir: "${{ env.DIRECTORY }}"
          script_path: "${{ github.workspace }}/scripts/generate_env_file.py"
          backend_stack_name: "${{ vars.PROJECT_PREFIX }}-backend-${{ vars.STAGE }}"
          auth_stack_name: "${{ vars.PROJECT_PREFIX }}-auth-${{ vars.STAGE }}"

  deploy-veda-data-airflow:
    name: deploy VEDA data airflow üçÉ
    runs-on: ubuntu-latest
    env:
      DIRECTORY: veda-data-airflow
      AWS_REGION: "us-west-2"
    needs: [deploy-veda-backend, deploy-veda-auth, define-environment]
    environment: ${{ needs.define-environment.outputs.env_name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          lfs: "true"
          submodules: "recursive"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.DEPLOYMENT_ROLE_ARN }}
          role-session-name: "${{ env.DIRECTORY }}-github-${{ needs.define-environment.outputs.env_name }}-deployment"
          aws-region: "${{ env.AWS_REGION }}"

      - name: Run deployment
        uses: "./veda-data-airflow/.github/actions/terraform-deploy"
        with:
          env-file: ".env"
          env_aws_secret_name: ${{ vars.DEPLOYMENT_ENV_SECRET_NAME }}
          dir: "${{ env.DIRECTORY }}"
          script_path: "${{ github.workspace }}/scripts/generate_env_file.py"
          backend_stack_name: "${{ vars.PROJECT_PREFIX }}-backend-${{ vars.STAGE }}"
          auth_stack_name: "${{ vars.PROJECT_PREFIX }}-auth-${{ vars.STAGE }}"
